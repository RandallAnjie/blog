---
title: 第4章 网络层
tags: []
id: '822'
categories:
  - - 研
comments: false
---

# 第四章 网络层

#计算机网络 目的：在任意结点间进行数据报传输

## 网络层功能

把分组从源端传送的目的端 网络层的功能：

1.  路由选择与分组转发（**选择最佳路径**）
2.  异构网络互连
3.  拥塞控制（宏观网络整体） 控制方法：
    1.  开环控制（静）（提前手动控制）
    2.  闭环控制（动）（系统自动调控）

### 路由与转发

**路由选择**：路由器之间的路由方式（**宏观**）（时间短，硬件解决） **分组转发**：到达输入链路之一的数据报如何传输到该路由器的输出链路之一（**微观**）（时间长，软件解决） ![网络层两大平面.png](/img/%E8%80%83%E7%A0%94/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/%E7%BD%91%E7%BB%9C%E5%B1%82%E4%B8%A4%E5%A4%A7%E5%B9%B3%E9%9D%A2.png) **数据平面**：对于数据处理过程中，各种具体处理转发过程 功能：根据转发表进行转发（路由器本地动作） **控制平面**：控制和管理网络协议的运行，比如OSPF协议、RIP协议、BGP协议

1.  传统方法（每路由方法） 路由选择算法运行在每台路由器中，每台路由器都包含转发和路由选择两种功能 ![传统控制平面.png](/img/%E8%80%83%E7%A0%94/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/%E4%BC%A0%E7%BB%9F%E6%8E%A7%E5%88%B6%E5%B9%B3%E9%9D%A2.png)
2.  SDN（Software Define Networking） 控制平面从路由器物理上分离，路由器仅实现转发，远程控制器计算和分发转发表以供每台路由器使用 ![sdn.png](/img/%E8%80%83%E7%A0%94/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/sdn.png)

**路由选择控制器**：

1.  传统：路由选择处理器**执行控制平面功能**。在传统的路由器中，它执行路由选择协议，维护路由选择表与关联链路状态信息，并为该路由器计算转发表
2.  SDN：在SDN路由器中，路由选择处理器**负责与远程控制器通信**，目的是接收远程控制器计算的转发表项

**SDN控制平面**：

1.  SDN控制器：维护准确的网络状态信息（远程链路、路由器和主机的状态)；为运行在控制平面中的网络控制应用程序提供这些信息（逻辑集中，在多台服务器上实现)
2.  网络控制应用程序：根据SDN控制器提供的方法，这些应用程序通过这些方法能够监视、编程和控制下面的网络设备

![sdn控制平面.png](/img/%E8%80%83%E7%A0%94/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/sdn%E6%8E%A7%E5%88%B6%E5%B9%B3%E9%9D%A2.png) **SDN控制器的三个层次**：

1.  对于网络控制应用程序的接口： SDN控制器通过”北向接口”与网络控制应用程序交互。该API允许网络控制应用程序在状态管理层之间读写网络状态
2.  网络范围状态管理层： 有SDN控制平面作出的最终控制决定，将要求控制器具有有关网络的主机、链路等最新状态信息
3.  通信层： SDN控制器与受控网络设备之间的通信(**OpenFlow协议（ATT：控制层面和数据层面之间的接口，而不是取代路由协议）**)，包含“南向接口”

![sdn控制器的三个层次.png](/img/%E8%80%83%E7%A0%94/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/sdn%E6%8E%A7%E5%88%B6%E5%99%A8%E7%9A%84%E4%B8%89%E4%B8%AA%E5%B1%82%E6%AC%A1.png)

## 路由算法

最佳路由：”最佳“只能是相对于某一种特定要求下得出的较为合理的选择

1.  静态路由算法（非自适应路由算法） 网络管理员手工配置路由信息 优点：简便、可靠，在负荷稳定、拓扑变化不大的网络中运行较好，用于高度安全性的军事网络和较小的商业网路 缺点：路由更新慢，不适用大型网络
2.  动态路由算法（自适应路由算法） 路由器上路由表项是通过相互连接的路由器之间彼此交换信息，然后按照一定算法优化出来的 优点：路由更新快，适用大型网络，及时响应链路费用或网络拓扑变化 缺点：算法复杂，增加网络负担
    1.  全局性 链路状态路由算法OSPF 所有路由器掌握完整的网络拓扑和链路费用信息 OSPF协议每个路由器得到完整拓扑结构后使用Dijkstra算法来计算路径
    2.  分散性 距离向量路由算法RIP 路由器只掌握物理相连的邻居及链路费用

### 路由层次

自治系统——AS：在单一的技术管理下的一组路由器，这些路由器使用一种AS内部路由选择协议和共同度量以确定该分组在该AS内的路由，同时还使用一种AS之间的路由协议来确定AS之间的路由 路由选择协议：

1.  内部网关协议IGP（一个AS内） 常用协议：RIP协议和OSPF协议
2.  外部网关协议EGP（AS之间） 常用协议：BGP协议

**网络的异构型**： 指的是传输介质、数据编码方式、链路控制协议及不同的数据单元格式和转发机制，这些特点分别在物理层和数据链路层被定义 **路由器互联的多个局域网中**： 物理层、数据链路层、**网络层**协议可以不同

## IPv4

### IPv4分组

IP数据报格式：\[\[第1章 计算机网络体系结构#^475694 （1Byte=8bit）\]\] !\[\[IP数据报格式.png\]\]

```tree
└─首部
   ├─固定部分（20B）
   └─可变部分
```

*   版本：使用的IP版本号，IPv4或者IPv6
*   首部长度：**占4位**，**以32位（4B）为单位**。能表示最大的十进制数为15（1111(2)），首部长度==最大值==为60B（15\*4B），首部长度==最小值==为20B（十进制数为5，5\*4B）
*   区分服务：指示期望获得哪种类型的服务
*   总长度（首部+数据）：**占16位**，**以单位为字节**。数据报的最大长度为216\-1=65535B。IP数据报成帧时，数据报的总长度不能超过当前链路层的\[\[第3章 数据链路层#^ed55c4MTU\]\]值
*   标识：**占16位**。它是一个计数器，每产生一个数据报就加1，并且赋值给标识字段，但是它不是序号（IP为无连接的服务）。超过\[\[第3章 数据链路层#^ed55c4MTU\]\]的数据报要分片，分片后的多个数据报的标识相同
*   标志：**占3位**，但是只有两位有意义，中间位（DF，Don't Fragment）和低位（MF，More Fragment）
    *   DF = 1 禁止分片
    *   DF = 0 允许分片
    *   MF = 1 该分片后面还有分片
    *   MF = 0 该分片为最后一个分片
*   片偏移：**占13位**，**以8字节为单位**。它指该分片在原分组中的相对位置。除了最后一个分组以外，其余的每个分片的分组长度一定是8B的整数倍。
*   生存时间（TTL，Time to Live）：**占8位**。防止分组在网络中循环，路由器在转发分组前会将TTL-1，如果TTL=0，则该分组必须被丢弃
*   协议：**占8位**。如TCP、UDP等。其中6表示TCP、17表示UDP
*   首部校验和：**占16位**。只校验首部，不校验数据部分
*   原地址：**占4B**。表示发送方IP
*   目的地址：**占4B**。表示接收方IP
*   填充：补0，使首部字段长为4B的整数倍

元素

占用空间

单位

版本

4位

首部长度

4位

4B

总长度

16位

1B

标识

16位

标志

3位

片偏移

13位

8B

生存时间

8B

协议

8B

首部校验和

16B

原地址

4B

目的地址

4B

^4dbf24 ==一种八片的首饰== 1总，8片，首4（单位B）

### IPv4地址与NAT

#### IPv4地址（点分十进制）

!\[\[分类的IP地址.png\]\] 3类常见的IP地址使用范围：

网络类别

最大可用网络数

第一份可用的网络号

最后一个可用的网络号

每个网络中的最大主机数（除去全0和全1）

A

27\-2（除去全0和127）

1

126

224\-2

B

214\-1（除去128.0）

128.1

191.255

216\-2

C

221\-1（除去192.0.0）

192.0.1

223.255.255

28\-2

特殊IP地址： !\[\[特殊IP地址.png\]\] 私有IP地址：

网络类别

地址范围

网段数

A

10.0.0.0～10.255.255.255

1

B

172.16.0.0～172.31.255.255

16

C

192.168.0.0～192.168.255.255

256

#### 网络地址转换NAT

网络地址转换是通过将专用网路地址转换为公用网络地址而对外隐藏内部管理的IP地址 NAT表项需要管理员添加，这样才能控制内网到外网的网络连接。如果主机发送的分组在NAT中找不到表项，则服务器不会转发该分组 典型的NAT转换表：

WAN端

LAN端

138.76.29.7， 50001

192.168.0.2， 1234

138.76.29.7， 5002

192.168.0.3， 2345

WAN端IP， 端口

LAN端IP， 端口

...

...

### 子网划分、子网掩码、CIDR

#### 子网划分

子网划分是单位内部是的事情，单位对外表现为没有划分子网的网络 !\[\[子网划分.png\]\] 二级IP地址：IP地址={<网络号>，<主机号>} 三级IP地址：IP地址={<网络号>，<子网号>，<主机号>}

> 对IPv4地址进行子网划分时，子网号不能为全0或全1，但是随着CIDR的使用，全0和全1的地址也能被指派

#### 子网掩码

IP地址与其子网掩码进行“与”运算能得出网络号（“与”运算：同“1”为1，其余为0）

八位二进制

十进制

10000000

128

11000000

192

11100000

224

11110000

240

11111000

248

11111100

252

11111110

254

11111111

255

路由器中路由表记录有：

1.  目的网络地址
2.  目的网络子网掩码
3.  下一跳地址

**路由器转发分组的算法**：

1.  提取目的IP地址
2.  是否能直接交付
3.  特定主机路由
4.  检测路由表中有无路径
5.  默认路由 0.0.0.0
6.  TTL等于0，丢弃报告转发分组出错

#### 无分类编址CIDR

\==CIDR是一种归并网络技术，CIDR技术就是将小的网络汇聚成大的超网== !\[\[CIDR划分网络.png\]\] CIDR记法：斜线记法（CIDR记法），IP地址后面写上”/“，再写上网络前缀的位数。 e.g. 192.168.31.2/24 CIDR地址块：网络前缀都相同的连续IP地址组成的 CIDR中地址掩码=子网划分中的子网掩码 构成超网（路由聚合）：将网络前缀缩短（将路由表中，同一个接口的表项合并，降低路由表中的行数） 最长前缀匹配：在查找路由表时会得到不止一个匹配结果，此时，应从匹配结果中选择具有最长网络前缀的路由，因为网络前缀越长，地址块越小，路由越具体

### ARP、DHCP与ICMP

#### 地址解析协议ARP

RARP：逆地址解析协议 由于在实际链路传输数据帧时，最终必须要使用MAC地址 ARP协议：完成主机或路由器IP地址到MAC地址的映射（解决下一跳走哪里的问题） ARP的使用过程：

*   检查ARP高速缓存，有对应表项则从表中获取MAC地址写入MAC帧，没有则将目的地址填为FF-FF-FF-FF-FF-FF的帧封装并==广播ARP请求分组==，目的主机收到请求会向源主机==单播一个ARP相应分组==源主机收到后将映射写入ARP高速缓存（10~20min更新一次）

ARP协议4种典型情况：

1.  同局域网主机A发送给主机B：ARP寻找B的MAC地址
2.  不同局域网主机A发送给主机B：ARP寻找本网络一个路由器（网关）的硬件地址
3.  局域网内路由器发送给主机A：ARP寻找A的MAC地址
4.  局域网1中路由器发送给局域网2主机B：用ARP找B的网关的地址

ARP请求与响应：（局域网内IP3为目的地址，局域网外IP3为网关IP地址） !\[\[ARP请求与响应.png\]\] 数据报中在链路层封装的目的MAC地址，局域网内填写目的主机MAC地址，局域网外填写网关MAC地址，待到数据到达网关后向WAN网转发数据报前会解封装，将数据链路层的目的MAC地址替换为下一跳的MAC地址

> \==源IP地址和目的IP地址不会因为转发分组重新封装而变换，只有源MAC地址和目的MAC地址会变化== 路由器在接到分组后，剥离该分组的数据链路层协议头，然后在分组被转发之前给分组加上一个新的链路层协议头（需要重新封装源硬件地址和目的硬件地址）

#### 动态主机配置协议DHCP

\[\[第1章 计算机网络体系结构#OSI参考模型DHCP\]\]协议是==\[\[第6章 应用层应用层\]\]==协议，使用的是==客户/服务器==方式，客户和服务器之间通过==**广播**\==进行交互，基于==**UDP**\== DHCP提供即插即用的联网机制，主机可以从服务器动态获取IP地址、子网掩码、默认网关、DNS服务器名称与IP地址，允许**地址重用**，支持**移动用户加入网络**，支持**再用地址续租** DHCP服务器和DHCP客户端的信息交换过程：

1.  主机广播==DHCP发现报文==：试图找到网络中的DHCP服务器来获得IP地址
2.  DHCP服务器广播==DHCP提供报文==：服务器拟分配一个IP及相关配置，当有多个服务器时，先到先得
3.  主机广播==DHCP请求报文==：主机向服务器请求IP地址
4.  DHCP服务器广播==DHCP确认报文==：正式将IP分配给主机

#### 网际控制报文协议ICMP

ICMP支持主机和路由器 产生差错（异常）->发送特定ICMP报文 ICMP数据报： !\[\[ICMP数据报.png\]\] ICMP报文分为两种：

1.  ICMP差错报文
2.  ICMP询问报文

##### ICMP差错报文

**ICMP差错报文用于以下5种情况**：

1.  终点不可达：(无法交付)
2.  源点抑制：(拥塞导致丢数据)（abandoned）
3.  时间超过：(TTL=0)
4.  参数问题：(首部字段出错)
5.  改变路由（重定向）：(可通过更好的路由)

ICMP差错报文数据字段： !\[\[ICMP差错报文数据字段.png\]\] **\==不发送==ICMP差错报文的情况**：

1.  对ICMP差错报文不再发送ICMP差错报文
2.  对第一个分片的数据报片的所有后续数据报片都不发送ICMP差错报告报文
3.  对具有组播地址的数据报都不发送ICMP差错报告报文
4.  对具有特殊地址（e.g. 127.0.0.1或0.0.0.0）的数据报不发送ICMP差错报告报文

> \==127.0.0.1是回环地址，以它为目的IP地址的数据会立即被返回本机== ==0.0.0.0/32可作为本主机在本网络上的源地址==

##### ICMP询问报文

**ICMP询问报文有以下4种**：

1.  回送请求和回答报文（测试目的站是否可达以及了解其相关状态）
2.  时间戳请求和回答报文（用来进行时钟同步和测量时间）
3.  地址掩码请求和回答报文（abandoned）
4.  路由器询问和通告报文（abandoned）

##### ICMP的应用

1.  PING：测试两个主机之间的连通性，使用了ICMP回送请求和回答报文
2.  Traceroute：跟踪一个分组从源点到终点的路径，使用了ICMP时间超过差错报告报文

## IPv6

从根本上解决地址耗尽问题 解决IP地址耗尽问题的措施：

1.  采用无分类编址CIDR汇聚小网络
2.  采用网络地址转换NAT方法以节省全球IP地址
3.  使用IPv6

IPv6数据报： !\[\[IPv6数据报.png\]\] IPv6数据报格式： !\[\[IPv6数据报格式.png\]\]

```tree
└─IPv6数据报格式
   ├─基本首部（40B）
   └─有效载荷
```

*   版本：指明了IP协议版本号，总为6
*   优先级：区分数据报的类别和优先级
*   流标签：从一个主机发往另一个主机的所有数据报都具有相同的流标签
*   有效载荷长度：拓展首部和数据部分长度
*   下一个首部：标志下一个扩展首部嚯上层协议的首部
*   跳数限制：相当于IPv4中的TTL
*   有效载荷：扩展首部+数据，相当于IPv4首部中的可变部分移到IPv6的有效载荷中

### IPv6的特点

1.  地址空间从IPv4的32位（4B）增长到128位（16B）
2.  改进首部格式
3.  能快速处理/转发
4.  支持QOS（Quality of Service）
5.  支持即插即用（自动配置，无需DHCP）
6.  支持资源预分配
7.  只允许在源点进行分片
8.  IPv6的首部长必须是8B的整数倍，\[\[第4章 网络层#^4dbf24IPv6的首部必须是4B的整数倍\]\]
9.  增大了安全性
10.  ICMPv6附加新增报文类型，分组过大

### IPv6地址

1.  一般形式：冒号十六进制e.g. fe80:0000:0000:0000:76ca:2a9b:000a:10f5
2.  压缩形式：删除多余的0，保证每组最少有一个数字e.g. fe80:0:0:0:76ca:2a9b:a:10f5
3.  0压缩形式：一连串的0可以用双冒号表示（::）一个IPv6地址中只能用一次双冒号e.g. fe80::76ca:2a9b:a:10f5

### IPv6基本地址类型

1.  单播：一对一通信，可作为源地址和目的地址
2.  多播：一对多通信，可作为目的地址
3.  任播：一对多中的一个通信，可作为目的地址（一对多通信，最先收到的接受消息）

### IPv4与IPv6过渡协议

1.  **双栈协议**：双协议栈技术就是指在一台设备上==同时启用Pv4协议栈和Pv6协议栈==。这样的话，这台设备既能和Pv4网络通信，又能和Pv6网络通信。如果这台设备是一个路由器，那么这台路由器的不同接口上，分别配置了IPv4地址和IPv6地址，并很可能分别连接了IPv4网络和IPv6网络。如果这台设备是一个计算机，那么它将同时拥有IPv4地址和Pv6地址，并具备同时处理这两个协议地址的功能
2.  **隧道技术**：通过使用互联网络的基础设施在网络之间传递数据的方式。使用隧道传递的数据（或负载）可以是不同协议的数据帧或包。隧道协议将其它协议的数据帧或包==重新封装==然后通过隧道发送 将IPv6的数据报作为数据部分加上IPv4的首部，即可在IPv4链路上传播

## 路由协议

### 路由信息协议RIP

> **\==应用层协议==基于==UDP数据报==** RIP是一种分布式的基于距离向量的路由选择协议，其最大的==优点就是简单==

RIP规定：

1.  网络中每个路由器都要维护它自身到其他每个目的网络的最佳距离
2.  距离，也称跳数，规定一个路由器直连一个网络，其跳数为1，每经过一个路由器，跳数加1
3.  RIP认为好的路由就是通过路由器的数量少，优先选择跳数少的路径
4.  RIP允许一条路径上最多只能包含15个路由器，即==距离为16时表示网络不可达==^RIP16bukeda
5.  RIP默认在==任意两个相邻的RIP路由器之间每30秒广播一次RIP路由更新信息==，==交换的信息是自己的路由表==，以便自动建立并维护路由表（动态维护）

**RIP协议中，RIP路由器每30秒仅和相邻的路由器交换自己的路由表**

#### 距离向量算法

执行步骤：

1.  修改相邻路由器发来的RIP报文中所有表项 对地址为X的相邻路由器发来的RIP报文，修改此报文中的所有项目：把“下一跳”字段中的地址改为X,并把所有的“距离”字段+1。
2.  对修改后的RIP报文中的每一个项目，进行以下步骤：
    1.  R1路由表中若没有Net3,则把该项目填入R1路由表
    2.  R1路由表中若有Net3,则查看下一跳路由器地址： 若下一跳是，则用收到的项目替换源路由表中的项目； 若下一跳不是X,原来距离比从走的距离远则更新，否则不作处理
3.  若180s还没收到相邻路由器X的更新路由表，则把X记为不可达的路由器，即把距离设置为16
4.  返回

RIP报文格式： !\[\[RIP报文格式.png\]\]

*   RIP是\[\[第6章 应用层应用层\]\]协议，使用的是UDP传输数据
*   一个RIP报文最多可以包含25个路由，如果超过则要再用一个RIP报文传输

RIP的缺点：

1.  RIP限制了网络规模，\[\[第4章 网络层#^RIP16bukeda最大距离为15（16表示不可达）\]\]
2.  \==RIP协议好消息传得快，坏消息传得慢==,当网络出现故障时，要经过比较长的时间（例如数分钟）才能将此信息传送到所有的路由器，“慢收敛”

### 开放最短路径优先协议OSPF

> **\==网络层协议==基于==IP数据报==** 使用**Dijkstra**的**最短路径算法SPF** 主要特征：使用了分布式链路状态协议

OSPF的特点： （1. 和谁交换信息，2. 交换什么信息，3. 什么时候交换信息）

1.  使用洪泛法向自治系统内**所有路由器**发送信息，即路由器通过输出端口向所有相邻的路由器发送信息，而每一个相邻路由器又再次将此信息发往其所有的相邻路由器==（广播）==
    *   最终整个区域内所有路由器都得到了这个信息的一个副本。
2.  发送的信息就是与本路由器**相邻的所有路由器的链路状态**（本路由器和哪些路由器相邻，以及该链路的度量/代价一一费用、距离、时延、带宽等)
3.  只有**当链路状态发生变化时**，路由器才向所有路由器洪泛发送此信息
    *   最后，所有路由器都能建立一个**链路状态数据库**，即**全网拓扑图**
4.  每隔30min,要刷新一次数据库中的链路状态
5.  由于一个路田器的链路状态只涉及到与相邻路由器的连通状态，因而与整个互联网的规模并无直接关系。因此当**互联网规模很大**时，OSPF协议要比距离向量协议RIP好得多
6.  OSPF不存在坏消息传的慢的问题，它的**收敛速度很快**

#### 链路状态路由算法

1.  每个路由器发现它的邻居结点【==HELLO问候分组==】，并了解邻居节点的网络地址，同时使用HELLO分组保持与其邻居的连接
2.  设置到它的每个邻居的成本度量==**metric**\==
3.  构造【==DD数据库描述分组==】，向邻站给出自己的链路状态数据库中的所有链路状态项目的摘要信息
4.  如果DD分组中的摘要自己都有，则邻站不做处理；如果有没有的或者是更新的，则发送【==LSR链路状态请求分组==】请求自己没有的和比自己更新的信息
5.  收到邻站的LSR分组后，发送【==LSU链路状态更新分组==】进行更新
6.  更新完毕后，邻站返回一个【==LSAck链路状态确认分组==】进行确认
    *   只要一个路由器的链路状态发生变化
7.  泛洪发送【==LSU链路状态更新分组==】进行更新
8.  更新完毕后，其他站返回一个【==LSAck链路状态确认分组==】进行确认
9.  使用Dijkstra根据自己的链路状态数据库构造到其他节点间的最短路径

OSPF的区域 !\[\[OSPF的区域.png\]\] OSPF的分组 !\[\[OSPF的分组.png\]\]

### 边界网关协议BGP

> **\==应用层协议==基于==TCP数据报==**

BGP协议的特点： （1. 和谁交换信息，2. 交换什么信息，3. 什么时候交换信息）

1.  与其他AS的邻站BGP发言人交换信息
2.  交换的网络可达性的信息，即要到达某个网络所要经过的一系列AS（BGP发言人交换路径向量）
3.  发生变化时更新有变化的部分
4.  BGP支持==CIDR==,因此BGP的路由表也就应当包括目的网络前缀、下一跳路由器，以及到达该目的网络所要经过的各个自治系统序列
5.  在BGP刚刚运行时，BGP的邻站是交换整个的BGP路由表。但以后==只需要在发生变化时更新有变化的部分==。这样做对节省网络带宽和减少路由器的处理开销都有好处

BGP协议交换信息的过程： BGP所交换的网络可达性的信息就是要==到达某个网络所要经过的一系列AS==。当BGP发言人互相交换了网络可达性的信息后，各BGP发言人就根据所米用的策略从收到的路由信息中找出到达各AS的较好路由 BGP协议报文格式： 一个BGP发言人与其他自治系统中的BGP发言人要交换路由信息，就要先建立TCP连接，即通过TCP传送，然后在此连接上交换BGP报文以建立BGP会话(session),利用BGP会话交换路由信息 !\[\[BGP协议报文格式.png\]\] BGP-4的四种报文：

1.  OPEN(打开)报文：用来与相邻的另一个BGP发言人建立关系，并认证发送方
2.  UPDATE(更新)报文：通告新路径或撤销原路径
3.  KEEPALIVE(保活)报文：在无UPDATEI时，周期性证实邻站的连通性；也作为OPEN的确认（确认存活报文）
4.  NOTIFICATION(通知)报文：报告先前报文的差错；也被用于关闭连接

### 三种路由协议的比较

**RIP**是一种分布式的基于距离向量的内部网关路由选择协议，通过广播UDP报文来交换路由信息 **OSPF**是一个内部网关协议，要交换的信息量较大，应使报文的长度尽量短，所以不使用传输层协议（如UDP或TCP),而是直接采用IP **BGP**是一个外部网关协议，在不同的自治系统之间交换路由信息，由于网络环境复杂，需要保证可靠传输，所以采用TCP

协议

RIP

OSPF

BGP

类型

内部

内部

外部

路由算法

距离-向量

链路状态

路径-向量

传递协议

UDP

IP

TCP

路径选择

跳数最少

代价最低

较好，非最佳

交换结点

和本结点相邻的路由器

网络中的所有路由器

和本结点相邻的路由器

交换内容

当前本路由器知道的全部信息，即自己的路由表

与本路由器相邻的所有路由器的链路状态

首次和整个路由表交换，非首次交换有变化的部分

## IP组播

IP数据报的三种传输方式：

1.  单播：==一对一==，单播用于发送数据包到单个目的地，且每发送一份单播报文都使用一个单播IP地址作为目的地址。是一种点对点传输方式。
2.  广播：==一对多==，广播是指发送数据包到同一广播域或子网内的所有设备的一种数据传输方式，是一种点对多点传输方式。
3.  组播：==一对多==，当网络中的某些用户需要特定数据时，组播数据发送者仅发送一次数据，借助组播路由协议为组播数据包建立组播分发树，被传递的数据到达距离用户端尽可能近的节点后才开始复制和分发，是一种点对多点传输方式。

> 能够运行组播协议的路由器被称为**组播路由器**

### IP组播地址

IP组播地址让源设备能够将分组发送给一组设备。属于多播组的设备将被分配一个组播组IP地址 一群共同需求主机的相同标识 组播使用地址范围为\[\[第4章 网络层#IPv4地址（点分十进制）D类地址\]\]，224.0.0.0~239.255.255.255，只能作为==**目的地址**\==，源地址只能为单播地址 特点：

1.  组播数据报也是“尽最大努力交付”，不提供可靠交付，应用于==**UDP**\==。
2.  对组播数据报不产生ICMP差错报文。
3.  并非所有D类地址都可以作为组播地址。

IP组播分为：

1.  因特网范围内组播
2.  硬件组播

#### 基于硬件组播的D类IP地址和组播物理地址映射：

同单播地址一样，组播IP地址也需要相应的组播MAC地址在本地网络中实际传送帧。组播MAC地址以十六进制值01-00-5E打头，余下的6个十六进制位是根据IP组播组地址的最后23位转换得到的。 TCP/IP协议使用的以太网多播地址的范围是: 从01-00-5E-00-00-00到01-00-5E-7F-FF-FF !\[\[D类IP地址和组播物理地址映射.png\]\] 由于组播IP中中存在5位IP不映射到物理地址上，所以映射关系不唯一，则可能导致两个不同的组播IP映射到同一个物理地址，所以**收到多播数据报的主机**，还要**在IP层利用软件进行过滤**，**把不是本主机要接收的数据报丢弃**。

### IGMP与组播路由算法

*   IGMP在一个路由器所管辖的局域网内
*   组播路由算法是在多个路由器之间、

#### IGMP

IGMP协议让路由器知道本局域网上是否有主机(的进程)参加或退出了某个组播组。 \[\[第4章 网络层#网际控制报文协议ICMPICMP\]\]和IGMP都使用IP数据报传递报文 IGMP工作的两个过程：（组播路由器知道的成员关系只是所连接的局域网中有无组播组的成员）

1.  某主机要**加入**组播组时，该主机**向组播组的组播地址**发送一个lGMP报文，声明自己要称为该组的成员。本地组播路由器收到lGMP报文后，要利用组播路由选择协议把这组成员关系发给因特网上的其他组播路由器。
    *   向组播组的组播地址发送一个lGMP报文：路由器和组播组中的主机知道新加入的主机
2.  本地组播路由器周期性探询本地局域网上的主机，以便知道这些主机是否还是组播组的成员。只要有一个主机对某个组响应，那么组播路由器就认为这个组是活跃的；如果经过几次探询后没有一个主机响应，组播路由器就认为本网络上的没有此组播组的主机，因此就不再把这组的成员关系发给其他的组播路由器。（响应方式类似IPv6的任播）

#### 组播路由算法

组播路由协议目的是找出==**以源主机为根节点的组播转发树**\== 构造树可以避免在路由器之间兜圈子 对不同的多播组对应于不同的多播转发树；同一个多播组，对不同的源点也会有不同的多播转发树 组播路由选择协议常使用的三种算法:

1.  基于链路状态的路由选择
2.  基于距离-向量的路由选择
3.  协议无关的组播（PIM）（稀疏/密集）

## 移动IP

移动IP技术是移动结点(计算机/服务器等)以固定的网络IP地址，实现跨越不同网段的漫游功能，并保证了基于网络IP的网络权限在漫游过程中不发生任何改变。 基本概念：

*   移动结点：具有永久IP地址的移动设备
*   归属代理（本地代理）：一个移动结点的永久“居所”称为归属网络，在归属网络中代表移动节点执行移动管理功能的实体叫做归属代理。
*   永久地址（归属地址/主地址）：移动站点在归属网络中的原始地址。
*   外部代理（外地代理）：在外部网络中帮助移动节点完成移动管理功能的实体称为外部代理。
*   转交地址（辅地址）：可以是外部代理的地址或动态配置的一个地址。

移动IP通信过程： !\[\[移动IP图示.png\]\] A刚进入外部网络：

1.  获得外部代理的转交地址(外部代理广播报文)
2.  移动节点通过外部代理发送注册报文给归属代理（包含永久地址&转交地址）
3.  归属代理接收请求，并将移动节点的永久地址和转交地址绑定（以后到达该归属代理的数据报且要发往移动节点的数据报将被封装并以隧道方式发给转交地址)，并返回一注册响应报文
4.  外部代理接收注册响应，并转发给移动节点

A移动到了下一个网络：

1.  在新外部代理登记注册一个转交地址
2.  新外部代理给本地代理发送新的转交地址（覆盖旧的）
3.  通信（同刚进入外部网络）

A回到了归属网络:

1.  A向本地代理注销转交地址
2.  按原始方式通信

## 网络层设备

### 冲突域和广播域

1.  冲突域指的是连接到同一物理介质上的所有结点集合，这些结点之间存在介质征用的现象
2.  广播域指的是接收同样广播消息的结点集合

\[\[第1章 计算机网络体系结构#^b35684隔离冲突域和广播域的设备\]\]以及三次设备的区别

设备

所属层次

能否隔离冲突域

能否隔离广播域

\[\[第2章 物理层#物理层设备集线器\]\]

\[\[第2章 物理层物理层\]\]

不能

不能

不能互联两个物理层不同的网段

\[\[第2章 物理层#物理层设备中继器\]\]

\[\[第2章 物理层物理层\]\]

不能

不能

\[\[第3章 数据链路层#交换机交换机\]\]

\[\[第3章 数据链路层数据链路层\]\]

能

不能

\[\[第3章 数据链路层#网桥网桥\]\]

\[\[第3章 数据链路层数据链路层\]\]

能

不能

可以互联两个物理层和链路层不同的网段

\[\[第4章 网络层#路由器的组成和功能路由器\]\]

\[\[第4章 网络层网络层\]\]

能

能

可以互联两个不同网络层协议的网段

路由器与\[\[第3章 数据链路层#^nodeswitch结点交换机\]\]的区别： 路由器用来互连不同的网络（能在多个网络转发分组），结点交换机只是**在一个特定的网络中工作**（能在单个网络中转发分组）

### 路由器的组成和功能

路由器是一种具有多个输入端口和多个输出端口的专用计算机，其任务是转发分组 路由器： !\[\[路由器.png\]\] 路由器分为路由选择部分（控制部分）和分组转发部分

*   路由选择部分：根据所选定的路由选择协议构造出路由表，同时经常或定期地和相邻路由器交换路由信息而不断地更新和维护路由表
*   分组转发部分分为输入端口、交换结构、输出部分
    *   交换结构：根据转发表（由路由表得来）对分组进行转发
        *   若收到RIP/OSPF分组等，则把分组送往路由选择处理机；若收到数据分组，则查找转发表并输出

转发与路由选择：

*   转发：将一个分组从一个端口转发到另一个端口（==微观上==）
*   路由选择：在路由器之间选择一个合适的路径把一个信息从源主机发送到目的主机（==宏观==）

输入端口对线路上收到的分组处理： !\[\[输入端口对线路上收到的分组处理.png\]\] 输入端口中的查找和转发功能在路由器的交换功能中是最重要的 输出端口将交换结构传送来的分组发送到线路： !\[\[输出端口将交换结构传送来的分组发送到线路.png\]\] 若路由器处理分组的速率赶不上分组进入队列的速率，则队列的存储空间最终必定减少到零，这就使后面再进入队列的分组由于没有存储空间而只能被丢弃 **\==路由器中的输入或输出队列产生溢出是造成分组丢失的重要原因==**

### 路由表与路由转发

#### 路由表

路由表根据路由选择算法得出的，主要用途是路由选择，总用==软件==来实现 !\[\[路由表.png\]\] ==默认路由的IP和掩码都是0.0.0.0==

#### 转发表

转发表由路由表得来，==可以用软件实现，也可以用特殊的硬件来实现==。转发表必须包含完成转发功能所必需的信息，在转发表的每一行必须包含从要到达的目的网络到输出端口和某些MA地址信息的映射